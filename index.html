<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Генератор редиректов для Nginx</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
        display: flex;
      }
      h1 {
        color: #333;
      }
      textarea,
      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
      }
      button {
        background-color: #28a745;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }
      button:hover {
        background-color: #218838;
      }
      .copy-button {
        background-color: #007bff;
      }
      .copy-button:hover {
        background-color: #0056b3;
      }
      .download-button {
        background-color: #ffc107;
      }
      .download-button:hover {
        background-color: #e0a800;
      }
      .clear-button {
        background-color: #dc3545;
      }
      .clear-button:hover {
        background-color: #c82333;
      }
      h2 {
        margin-top: 20px;
        color: #333;
      }
      pre {
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      .notification {
        margin-top: 10px;
        color: #28a745;
        font-weight: bold;
      }
      .instructions {
        margin-left: 20px;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        position: sticky;
        top: 20px;
      }
      .error {
        margin-top: 10px;
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Генератор редиректов для Nginx</h1>
      <textarea
        id="inputUrls"
        rows="10"
        placeholder="Введите адреса, по одному на строку..."
      ></textarea>
      <label for="targetUrl">Введите целевой URL:</label>
      <input
        type="text"
        id="targetUrl"
        placeholder="https://example.com/target"
      />
      <button id="generateButton">Сгенерировать редиректы</button>
      <button id="copyButton" class="copy-button">Скопировать вывод</button>
      <button id="downloadButton" class="download-button">
        Скачать redirects.conf
      </button>
      <button id="clearButton" class="clear-button">Очистить все</button>
      <h2>Результат:</h2>
      <div id="notification" class="notification"></div>
      <div id="error" class="error"></div>
      <pre id="output"></pre>
    </div>
    <div class="instructions">
      <h2>Инструкция</h2>
      <p>1. Введите адреса, по одному на строку, в текстовое поле.</p>
      <p>2. Укажите целевой URL, на который будут перенаправлены запросы.</p>
      <p>3. Нажмите "Сгенерировать редиректы", чтобы получить конфигурацию.</p>
      <p>4. Скопируйте вывод или скачайте файл <code>redirects.conf</code>.</p>
      <p>
        5. Вы можете вставить сгенерированные редиректы прямо в конфигурацию
        Nginx:
      </p>
      <pre>
server {
    ...
    # тут редиректы
}</pre
      >
      <p>
        или добавить <code>redirects.conf</code> в корень проекта и прописать в
        Nginx:
      </p>
      <pre>
server {
    ...
    include /path/to/your/site/from/root/redirects.conf;
}</pre
      >
    </div>

    <script>
      document
        .getElementById("generateButton")
        .addEventListener("click", function () {
          const input = document.getElementById("inputUrls").value;
          const targetUrl = document.getElementById("targetUrl").value.trim();
          const urls = input
            .split("\n")
            .map((url) => url.trim())
            .filter((url) => url);
          const output = document.getElementById("output");
          const error = document.getElementById("error");
          error.textContent = "";

          if (!targetUrl) {
            output.textContent = "Пожалуйста, введите целевой URL.";
            return;
          }

          output.textContent = generateNginxRedirects(urls, targetUrl);
        });

      function generateNginxRedirects(urls, targetUrl) {
        const targetUrlLine = `set $target_url_ ${targetUrl};\n\n`;
        const groupedRedirects = {};
        let queryRedirects = "";
        const uniqueParams = new Set();
        let firstParamProcessed = false;

        urls.forEach((url) => {
          try {
            const decodedUrl = decodeURIComponent(url);
            const parsedUrl = new URL(decodedUrl);
            const path = parsedUrl.pathname;

            const params = parsedUrl.searchParams;
            for (const [key, value] of params) {
              if (!firstParamProcessed) {
                queryRedirects += `if ($args ~* "^${key}=(.*)") {\n    return 301 ${targetUrl};\n}\n`;
                firstParamProcessed = true;
              }

              if (!uniqueParams.has(key)) {
                queryRedirects += `if ($args ~* "^${key}=(.*)") {\n    return 301 ${targetUrl};\n}\n`;
                uniqueParams.add(key);
              }
            }

            const segments = path.split("/").filter((segment) => segment);
            const prefix = segments.length > 0 ? segments[0] : "";

            if (!groupedRedirects[prefix]) {
              groupedRedirects[prefix] = [];
            }
            groupedRedirects[prefix].push(path);
          } catch (e) {
            document.getElementById(
              "error"
            ).textContent = `Некорректный URL: ${url}`;
          }
        });

        const redirects = Object.keys(groupedRedirects).map((prefix) => {
          return `rewrite ^/${prefix}(.*)?$ $target_url_ permanent;`;
        });

        const filteredRedirects = redirects.filter(
          (item) => !item.includes("rewrite ^/(.*)?$")
        );

        return (
          targetUrlLine + queryRedirects + filteredRedirects.join("\n") + "\n"
        );
      }

      document
        .getElementById("copyButton")
        .addEventListener("click", function () {
          const output = document.getElementById("output");
          const notification = document.getElementById("notification");
          navigator.clipboard
            .writeText(output.textContent)
            .then(() => {
              notification.textContent = "Вывод скопирован в буфер обмена!";
              setTimeout(() => {
                notification.textContent = "";
              }, 3000);
            })
            .catch((err) => {
              console.error("Ошибка при копировании: ", err);
            });
        });

      document
        .getElementById("downloadButton")
        .addEventListener("click", function () {
          const output = document.getElementById("output").textContent;
          const blob = new Blob([output], { type: "text/plain" });
          const link = document.createElement("a");
          link.href = window.URL.createObjectURL(blob);
          link.download = "redirects.conf";
          link.click();
          window.URL.revokeObjectURL(link.href);
        });

      document
        .getElementById("clearButton")
        .addEventListener("click", function () {
          document.getElementById("inputUrls").value = "";
          document.getElementById("targetUrl").value = "";
          document.getElementById("output").textContent = "";
          document.getElementById("notification").textContent = "";
          document.getElementById("error").textContent = "";
        });
    </script>
  </body>
</html>
